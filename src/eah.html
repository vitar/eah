<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Estimation Alignment Tool (MVP)</title>
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      padding: 0;
      background: #f4f5f7;
      color: #222;
    }
    header {
      background: #0b7285;
      color: white;
      padding: 12px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    header h1 {
      margin: 0;
      font-size: 18px;
    }
    header .actions button {
      margin-left: 8px;
    }
    nav {
      background: #e9ecef;
      padding: 8px 12px;
      display: flex;
      gap: 8px;
      border-bottom: 1px solid #ced4da;
    }
    nav button {
      border: none;
      background: transparent;
      padding: 6px 10px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 13px;
    }
    nav button.active {
      background: #0b7285;
      color: white;
    }
    main {
      padding: 16px 20px 32px;
      max-width: 1200px;
    }
    section {
      display: none;
    }
    section.active {
      display: block;
    }
    h2 {
      margin-top: 0;
    }
    table {
      border-collapse: collapse;
      width: 100%;
      margin-top: 8px;
      background: white;
    }
    th, td {
      border: 1px solid #ced4da;
      padding: 4px 6px;
      font-size: 12px;
      vertical-align: top;
    }
    th {
      background: #f1f3f5;
    }
    input[type="text"],
    input[type="number"],
    select,
    textarea {
      width: 100%;
      box-sizing: border-box;
      font-size: 12px;
      padding: 2px 4px;
    }
    textarea {
      resize: vertical;
      min-height: 40px;
    }
    .small {
      width: 60px;
    }
    .btn {
      font-size: 12px;
      padding: 4px 8px;
      border-radius: 4px;
      border: 1px solid #adb5bd;
      background: #fff;
      cursor: pointer;
    }
    .btn-primary {
      background: #0b7285;
      border-color: #0b7285;
      color: #fff;
    }
    .btn-danger {
      background: #c92a2a;
      border-color: #c92a2a;
      color: #fff;
    }
    .toolbar {
      margin: 8px 0;
      display: flex;
      gap: 8px;
      align-items: center;
      flex-wrap: wrap;
    }
    .tag {
      display: inline-block;
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 11px;
    }
    .tag-low { background: #d3f9d8; }
    .tag-med { background: #fff3bf; }
    .tag-high { background: #ffe3e3; }
    .tag-extreme { background: #ff6b6b; color: white; }

    .alert {
      padding: 6px 10px;
      border-radius: 4px;
      font-size: 12px;
      margin-top: 8px;
    }
    .alert-info {
      background: #e7f5ff;
      border: 1px solid #74c0fc;
    }
    .alert-warning {
      background: #fff3bf;
      border: 1px solid #fcc419;
    }
    .alert-danger {
      background: #ffe3e3;
      border: 1px solid #fa5252;
    }
  </style>
</head>
<body>
<header>
  <h1>Estimation Alignment Tool (Complexity & Uncertainty)</h1>
  <div class="actions">
    <button class="btn" id="btnExport">Export JSON</button>
    <label class="btn">
      Import JSON
      <input type="file" id="fileImport" style="display:none" accept="application/json" />
    </label>
  </div>
</header>

<nav>
  <button data-section="getting-started" class="active">Getting Started</button>
  <button data-section="config">Config</button>
  <button data-section="features">Features & Baseline</button>
  <button data-section="drift">Drift & Signals</button>
</nav>

<main>
  <!-- Getting Started -->
  <section id="getting-started" class="active">
    <h2>Getting Started</h2>
    <div class="alert alert-info">
      This page is a browser-based mini-tool for <strong>initial estimation</strong> and
      <strong>early drift detection</strong> using Complexity &amp; Uncertainty. All data is stored
      locally in your browser (localStorage). Use <strong>Export JSON</strong> to back up or share.
    </div>
    <h3>Minimum viable use (first project)</h3>
    <ol>
      <li>Open the <strong>Config</strong> tab and review the Complexity and Uncertainty drivers.
          Adjust descriptions if needed.</li>
      <li>Open <strong>Features &amp; Baseline</strong> and add one row per EPIC / feature.</li>
      <li>For each feature, score each driver (0, 1, 2, 3, 5). The tool will calculate
          <strong>Complexity total</strong>, <strong>band</strong>, and
          <strong>Uncertainty total</strong>.</li>
      <li>Use Complexity band and Uncertainty total during RFP / discovery discussions and to
          prioritise where you need more clarification.</li>
      <li>As the project moves, update scores when new complexity appears or uncertainty decreases.</li>
      <li>Open <strong>Drift &amp; Signals</strong> to see where complexity has increased or
          uncertainty is not going down. Use this as input for scope/timeline/team discussions.</li>
    </ol>

    <h3>How data is stored</h3>
    <ul>
      <li>All data is kept in your browser’s <code>localStorage</code> under a single key.</li>
      <li>Use <strong>Export JSON</strong> to download a backup file.</li>
      <li>Use <strong>Import JSON</strong> to restore or share a snapshot.</li>
    </ul>

    <h3>Scoring hints</h3>
    <ul>
      <li><strong>0</strong> – Not relevant / no impact.</li>
      <li><strong>1</strong> – Low impact, known pattern.</li>
      <li><strong>2</strong> – Medium impact, some complexity.</li>
      <li><strong>3</strong> – High impact, difficult or risky.</li>
      <li><strong>5</strong> – Extreme / red flag; talk about it explicitly.</li>
    </ul>

    <p style="font-size:12px;color:#555;">
      This is an MVP. It intentionally focuses on the core: drivers, features, baseline, and drift.
      RFP calculators, delivery checkpoints, and decision logs can be added later once this gets
      real usage.
    </p>
  </section>

  <!-- Config -->
  <section id="config">
    <h2>Config – Drivers</h2>
    <p>These are the <strong>Complexity</strong> and <strong>Uncertainty</strong> drivers used for scoring.</p>
    <div class="toolbar">
      <button class="btn btn-primary" id="btnAddComplexityDriver">Add Complexity Driver</button>
      <button class="btn btn-primary" id="btnAddUncertaintyDriver">Add Uncertainty Driver</button>
    </div>
    <h3>Complexity Drivers</h3>
    <table id="tblComplexityDrivers">
      <thead>
        <tr>
          <th>Key</th>
          <th>Description</th>
          <th class="small">Actions</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <h3>Uncertainty Drivers</h3>
    <table id="tblUncertaintyDrivers">
      <thead>
        <tr>
          <th>Key</th>
          <th>Description</th>
          <th class="small">Actions</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </section>

  <!-- Features & Baseline -->
  <section id="features">
    <h2>Features &amp; Baseline</h2>
    <div class="toolbar">
      <button class="btn btn-primary" id="btnAddFeature">Add Feature</button>
    </div>
    <table id="tblFeatures">
      <thead>
        <tr id="tblFeaturesHeaderRow">
          <!-- dynamic -->
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    <div class="alert alert-info">
      <strong>Tip:</strong> Complexity band is derived from total complexity:
      <span class="tag tag-low">Low</span> (0–3),
      <span class="tag tag-med">Medium</span> (4–7),
      <span class="tag tag-high">High</span> (8–12),
      <span class="tag tag-extreme">Extreme</span> (13+).
    </div>
  </section>

  <!-- Drift & Signals -->
  <section id="drift">
    <h2>Drift &amp; Signals</h2>
    <p>This view compares the <strong>current</strong> complexity/uncertainty of each feature to its
       <strong>stored baseline snapshot</strong>. Use it to detect early where things diverge.</p>
    <div class="toolbar">
      <button class="btn" id="btnSnapshotBaseline">Snapshot current as baseline (vX)</button>
    </div>
    <table id="tblDrift">
      <thead>
        <tr>
          <th>Feature ID</th>
          <th>Name</th>
          <th>Baseline Version</th>
          <th>Baseline Complexity</th>
          <th>Current Complexity</th>
          <th>Drift (Abs)</th>
          <th>Drift (%)</th>
          <th>Baseline Uncertainty</th>
          <th>Current Uncertainty</th>
          <th>Uncertainty Δ</th>
          <th>Signal</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    <div class="alert alert-warning">
      As a guideline:
      <ul>
        <li>~10–25% complexity drift → early warning.</li>
        <li>&gt;25–30% drift → consider scope / timeline / team adjustments.</li>
        <li>Uncertainty should normally go down over time; if it goes up, discovery is incomplete.</li>
      </ul>
    </div>
  </section>
</main>

<script>
  // --- Data model & persistence ----------------------------------------------------

  const STORAGE_KEY = "estimationAlignmentData_v1";

  const defaultData = {
    config: {
      complexityDrivers: [
        { key: "Integration", description: "Integration points, APIs, upstream/downstream systems" },
        { key: "Data", description: "Data models, transformations, data quality, migrations" },
        { key: "UX", description: "UI complexity, number of screens, branching flows" },
        { key: "Logic", description: "Business rules, edge cases, calculations, workflows" },
        { key: "SecurityCompliance", description: "Security, privacy, regulatory or compliance work" },
        { key: "NFR", description: "Performance, scalability, availability and other NFRs" },
        { key: "TeamFit", description: "Team experience with tech stack and domain" },
        { key: "ExternalDeps", description: "External teams/vendors/third parties we depend on" },
        { key: "EnvDevOps", description: "Environments, pipelines, deployment, monitoring, tooling" }
      ],
      uncertaintyDrivers: [
        { key: "ReqClarity", description: "Clarity and stability of requirements" },
        { key: "StakeholderAlign", description: "Agreement between stakeholders on goals and scope" },
        { key: "DomainAmbiguity", description: "Unknown business/domain rules or edge cases" },
        { key: "DepOwnership", description: "Clarity of ownership for dependencies and integrations" },
        { key: "DocAvailability", description: "Availability and quality of specs/docs/references" },
        { key: "SpikesNeeded", description: "Need for spikes/PoCs to explore unknowns" },
        { key: "UnpredictableHistory", description: "History of surprises, rework, or failures" },
        { key: "CrossTeamCoord", description: "Number and unpredictability of cross-team interactions" },
        { key: "ClientProcess", description: "Internal client processes (access, approvals, change mgmt)" }
      ]
    },
    features: [
      // example:
      // {
      //   id: "FEAT-001",
      //   name: "Example Feature",
      //   valueRating: "H",
      //   tshirtSize: "M",
      //   baselineVersion: "v1",
      //   status: "Planned",
      //   complexityScores: { C_Integration: 2, ... },
      //   uncertaintyScores: { U_ReqClarity: 2, ... },
      //   baselineSnapshot: { complexityTotal: 18, uncertaintyTotal: 14, version: "v1" }
      // }
    ]
  };

  function loadData() {
    try {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) return structuredClone(defaultData);
      const parsed = JSON.parse(raw);
      // Shallow merge to keep backwards compatibility
      return {
        config: parsed.config || structuredClone(defaultData.config),
        features: parsed.features || []
      };
    } catch (e) {
      console.error("Failed to load data, using defaults", e);
      return structuredClone(defaultData);
    }
  }

  function saveData() {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
  }

  let data = loadData();

  // --- Helpers ---------------------------------------------------------------------

  function computeComplexityTotal(feature) {
    const scores = feature.complexityScores || {};
    return Object.values(scores).reduce((sum, v) => sum + (Number(v) || 0), 0);
  }

  function computeUncertaintyTotal(feature) {
    const scores = feature.uncertaintyScores || {};
    return Object.values(scores).reduce((sum, v) => sum + (Number(v) || 0), 0);
  }

  function complexityBand(total) {
    if (total <= 3) return "Low";
    if (total <= 7) return "Medium";
    if (total <= 12) return "High";
    return "Extreme";
  }

  function bandClass(band) {
    switch (band) {
      case "Low": return "tag tag-low";
      case "Medium": return "tag tag-med";
      case "High": return "tag tag-high";
      case "Extreme": return "tag tag-extreme";
      default: return "tag";
    }
  }

  function percentageDiff(base, current) {
    if (!base) return 0;
    return (current - base) / base;
  }

  // --- Navigation ------------------------------------------------------------------

  document.querySelectorAll("nav button").forEach(btn => {
    btn.addEventListener("click", () => {
      const target = btn.dataset.section;
      document.querySelectorAll("nav button").forEach(b => b.classList.remove("active"));
      document.querySelectorAll("main section").forEach(sec => sec.classList.remove("active"));
      btn.classList.add("active");
      document.getElementById(target).classList.add("active");
    });
  });

  // --- Config rendering & events ---------------------------------------------------

  const tblComplexityDrivers = document.getElementById("tblComplexityDrivers").querySelector("tbody");
  const tblUncertaintyDrivers = document.getElementById("tblUncertaintyDrivers").querySelector("tbody");

  function renderDrivers() {
    // Complexity
    tblComplexityDrivers.innerHTML = "";
    data.config.complexityDrivers.forEach((d, idx) => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td><input type="text" value="${d.key}" data-type="complexity" data-idx="${idx}" data-field="key" /></td>
        <td><textarea data-type="complexity" data-idx="${idx}" data-field="description">${d.description || ""}</textarea></td>
        <td><button class="btn btn-danger" data-type="complexity" data-idx="${idx}" data-action="delete">X</button></td>
      `;
      tblComplexityDrivers.appendChild(tr);
    });

    // Uncertainty
    tblUncertaintyDrivers.innerHTML = "";
    data.config.uncertaintyDrivers.forEach((d, idx) => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td><input type="text" value="${d.key}" data-type="uncertainty" data-idx="${idx}" data-field="key" /></td>
        <td><textarea data-type="uncertainty" data-idx="${idx}" data-field="description">${d.description || ""}</textarea></td>
        <td><button class="btn btn-danger" data-type="uncertainty" data-idx="${idx}" data-action="delete">X</button></td>
      `;
      tblUncertaintyDrivers.appendChild(tr);
    });
  }

  function attachDriverEvents() {
    document.getElementById("btnAddComplexityDriver").onclick = () => {
      data.config.complexityDrivers.push({ key: "C_New", description: "" });
      saveData();
      renderDrivers();
      renderFeatures(); // columns might change
      renderDrift();
      attachDriverEvents();
    };
    document.getElementById("btnAddUncertaintyDriver").onclick = () => {
      data.config.uncertaintyDrivers.push({ key: "U_New", description: "" });
      saveData();
      renderDrivers();
      renderFeatures();
      renderDrift();
      attachDriverEvents();
    };

    // Delegate for inputs & delete buttons
    [tblComplexityDrivers, tblUncertaintyDrivers].forEach(tbody => {
      tbody.onclick = (e) => {
        const btn = e.target.closest("button");
        if (!btn) return;
        const type = btn.dataset.type;
        const idx = Number(btn.dataset.idx);
        const action = btn.dataset.action;
        if (action === "delete") {
          if (type === "complexity") data.config.complexityDrivers.splice(idx, 1);
          else data.config.uncertaintyDrivers.splice(idx, 1);
          saveData();
          renderDrivers();
          renderFeatures();
          renderDrift();
          attachDriverEvents();
        }
      };
      tbody.oninput = (e) => {
        const el = e.target;
        const type = el.dataset.type;
        if (!type) return;
        const idx = Number(el.dataset.idx);
        const field = el.dataset.field;
        const list = type === "complexity" ? data.config.complexityDrivers : data.config.uncertaintyDrivers;
        list[idx][field] = el.value;
        saveData();
        renderFeatures();
        renderDrift();
      };
    });
  }

  // --- Features rendering & events -------------------------------------------------

  const tblFeatures = document.getElementById("tblFeatures").querySelector("tbody");
  const tblFeaturesHeaderRow = document.getElementById("tblFeaturesHeaderRow");

  function renderFeaturesHeader() {
    tblFeaturesHeaderRow.innerHTML = "";
    const baseCols = [
      "Feature ID",
      "Name",
      "Value (H/M/L)",
      "T-Shirt (XS–XL)",
      "Baseline Version",
      "Status"
    ];
    baseCols.forEach(text => {
      const th = document.createElement("th");
      th.textContent = text;
      tblFeaturesHeaderRow.appendChild(th);
    });

    // Complexity drivers
    data.config.complexityDrivers.forEach(d => {
      const th = document.createElement("th");
      th.textContent = d.key;
      tblFeaturesHeaderRow.appendChild(th);
    });
    const thCT = document.createElement("th");
    thCT.textContent = "Complexity Total";
    tblFeaturesHeaderRow.appendChild(thCT);
    const thBand = document.createElement("th");
    thBand.textContent = "Band";
    tblFeaturesHeaderRow.appendChild(thBand);

    // Uncertainty drivers
    data.config.uncertaintyDrivers.forEach(d => {
      const th = document.createElement("th");
      th.textContent = d.key;
      tblFeaturesHeaderRow.appendChild(th);
    });
    const thUT = document.createElement("th");
    thUT.textContent = "Uncertainty Total";
    tblFeaturesHeaderRow.appendChild(thUT);

    const thNotes = document.createElement("th");
    thNotes.textContent = "Notes";
    tblFeaturesHeaderRow.appendChild(thNotes);

    const thActions = document.createElement("th");
    thActions.textContent = "Actions";
    tblFeaturesHeaderRow.appendChild(thActions);
  }

  function renderFeatures() {
    renderFeaturesHeader();
    tblFeatures.innerHTML = "";
    data.features.forEach((f, idx) => {
      const tr = document.createElement("tr");

      const complexityTotal = computeComplexityTotal(f);
      const band = complexityBand(complexityTotal);
      const uncertaintyTotal = computeUncertaintyTotal(f);

      // Base fields
      tr.innerHTML = `
        <td><input type="text" value="${f.id || ""}" data-fidx="${idx}" data-field="id" /></td>
        <td><input type="text" value="${f.name || ""}" data-fidx="${idx}" data-field="name" /></td>
        <td>
          <select data-fidx="${idx}" data-field="valueRating">
            <option value=""></option>
            <option value="H" ${f.valueRating === "H" ? "selected" : ""}>H</option>
            <option value="M" ${f.valueRating === "M" ? "selected" : ""}>M</option>
            <option value="L" ${f.valueRating === "L" ? "selected" : ""}>L</option>
          </select>
        </td>
        <td>
          <select data-fidx="${idx}" data-field="tshirtSize">
            <option value=""></option>
            <option value="XS" ${f.tshirtSize === "XS" ? "selected" : ""}>XS</option>
            <option value="S" ${f.tshirtSize === "S" ? "selected" : ""}>S</option>
            <option value="M" ${f.tshirtSize === "M" ? "selected" : ""}>M</option>
            <option value="L" ${f.tshirtSize === "L" ? "selected" : ""}>L</option>
            <option value="XL" ${f.tshirtSize === "XL" ? "selected" : ""}>XL</option>
          </select>
        </td>
        <td><input type="text" value="${f.baselineVersion || ""}" data-fidx="${idx}" data-field="baselineVersion" /></td>
        <td>
          <select data-fidx="${idx}" data-field="status">
            <option value=""></option>
            <option value="Planned" ${f.status === "Planned" ? "selected" : ""}>Planned</option>
            <option value="In Progress" ${f.status === "In Progress" ? "selected" : ""}>In Progress</option>
            <option value="Done" ${f.status === "Done" ? "selected" : ""}>Done</option>
          </select>
        </td>
      `;

      // Complexity driver inputs
      data.config.complexityDrivers.forEach(d => {
        const td = document.createElement("td");
        const val = (f.complexityScores && f.complexityScores[d.key]) ?? "";
        td.innerHTML = `<input type="number" min="0" max="5" class="small" value="${val}" data-fidx="${idx}" data-cdk="${d.key}" />`;
        tr.appendChild(td);
      });

      // Complexity total + band
      const tdCT = document.createElement("td");
      tdCT.textContent = complexityTotal;
      tr.appendChild(tdCT);

      const tdBand = document.createElement("td");
      tdBand.innerHTML = `<span class="${bandClass(band)}">${band}</span>`;
      tr.appendChild(tdBand);

      // Uncertainty driver inputs
      data.config.uncertaintyDrivers.forEach(d => {
        const td = document.createElement("td");
        const val = (f.uncertaintyScores && f.uncertaintyScores[d.key]) ?? "";
        td.innerHTML = `<input type="number" min="0" max="5" class="small" value="${val}" data-fidx="${idx}" data-udk="${d.key}" />`;
        tr.appendChild(td);
      });

      const tdUT = document.createElement("td");
      tdUT.textContent = uncertaintyTotal;
      tr.appendChild(tdUT);

      const tdNotes = document.createElement("td");
      tdNotes.innerHTML = `<textarea data-fidx="${idx}" data-field="notes">${f.notes || ""}</textarea>`;
      tr.appendChild(tdNotes);

      const tdActions = document.createElement("td");
      tdActions.innerHTML = `<button class="btn btn-danger" data-fidx="${idx}" data-action="delete">Delete</button>`;
      tr.appendChild(tdActions);

      tblFeatures.appendChild(tr);
    });

    attachFeatureEvents();
  }

  function attachFeatureEvents() {
    document.getElementById("btnAddFeature").onclick = () => {
      data.features.push({
        id: "",
        name: "",
        valueRating: "",
        tshirtSize: "",
        baselineVersion: "v1",
        status: "Planned",
        complexityScores: {},
        uncertaintyScores: {},
        notes: ""
      });
      saveData();
      renderFeatures();
      renderDrift();
    };

    tblFeatures.onclick = (e) => {
      const btn = e.target.closest("button");
      if (!btn) return;
      const idx = Number(btn.dataset.fidx);
      const action = btn.dataset.action;
      if (action === "delete") {
        data.features.splice(idx, 1);
        saveData();
        renderFeatures();
        renderDrift();
      }
    };

    tblFeatures.oninput = (e) => {
      const el = e.target;
      const idx = Number(el.dataset.fidx);
      if (Number.isNaN(idx)) return;
      const feature = data.features[idx];

      if (el.dataset.field) {
        feature[el.dataset.field] = el.value;
      }
      if (el.dataset.cdk) {
        feature.complexityScores = feature.complexityScores || {};
        feature.complexityScores[el.dataset.cdk] = Number(el.value || 0);
      }
      if (el.dataset.udk) {
        feature.uncertaintyScores = feature.uncertaintyScores || {};
        feature.uncertaintyScores[el.dataset.udk] = Number(el.value || 0);
      }

      saveData();
      renderFeatures();
      renderDrift();
    };
  }

  // --- Drift view -----------------------------------------------------------------

  const tblDriftBody = document.getElementById("tblDrift").querySelector("tbody");

  function renderDrift() {
    tblDriftBody.innerHTML = "";
    data.features.forEach(f => {
      const currentCT = computeComplexityTotal(f);
      const currentUT = computeUncertaintyTotal(f);

      const baseline = f.baselineSnapshot || {
        complexityTotal: currentCT,
        uncertaintyTotal: currentUT,
        version: f.baselineVersion || ""
      };

      const driftAbs = currentCT - baseline.complexityTotal;
      const driftPct = percentageDiff(baseline.complexityTotal, currentCT);
      const uncertDelta = currentUT - baseline.uncertaintyTotal;

      let signal = "";
      if (baseline.complexityTotal > 0 && Math.abs(driftPct) >= 0.25) {
        signal = "Check complexity drift";
      } else if (uncertDelta > 0) {
        signal = "Uncertainty increasing";
      }

      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${f.id || ""}</td>
        <td>${f.name || ""}</td>
        <td>${baseline.version || ""}</td>
        <td>${baseline.complexityTotal}</td>
        <td>${currentCT}</td>
        <td>${driftAbs}</td>
        <td>${baseline.complexityTotal ? (driftPct * 100).toFixed(1) + "%" : ""}</td>
        <td>${baseline.uncertaintyTotal}</td>
        <td>${currentUT}</td>
        <td>${uncertDelta}</td>
        <td>${signal}</td>
      `;
      tblDriftBody.appendChild(tr);
    });
  }

  document.getElementById("btnSnapshotBaseline").onclick = () => {
    const newVersion = prompt("Baseline version label (e.g., v1, v2, v3):", "v2");
    if (!newVersion) return;
    data.features.forEach(f => {
      const currentCT = computeComplexityTotal(f);
      const currentUT = computeUncertaintyTotal(f);
      f.baselineVersion = newVersion;
      f.baselineSnapshot = {
        version: newVersion,
        complexityTotal: currentCT,
        uncertaintyTotal: currentUT
      };
    });
    saveData();
    renderFeatures();
    renderDrift();
  };

  // --- Export / Import ------------------------------------------------------------

  document.getElementById("btnExport").onclick = () => {
    const blob = new Blob([JSON.stringify(data, null, 2)], { type: "application/json" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    const ts = new Date().toISOString().slice(0, 19).replace(/[:T]/g, "-");
    a.download = `estimation-data-${ts}.json`;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  };

  document.getElementById("fileImport").addEventListener("change", (e) => {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = (ev) => {
      try {
        const imported = JSON.parse(ev.target.result);
        if (!imported.config || !imported.features) {
          alert("Invalid JSON: expected { config, features }.");
          return;
        }
        data = imported;
        saveData();
        renderDrivers();
        attachDriverEvents();
        renderFeatures();
        renderDrift();
        alert("Import successful. Data replaced.");
      } catch (err) {
        console.error(err);
        alert("Failed to parse JSON file.");
      }
    };
    reader.readAsText(file);
    e.target.value = ""; // reset
  });

  // --- Initial render -------------------------------------------------------------

  renderDrivers();
  attachDriverEvents();
  renderFeatures();
  renderDrift();
</script>
</body>
</html>
